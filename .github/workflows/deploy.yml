name: Deploy Block Builder License Server

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  PROJECT_DIR: .

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          docker build -t bb-license-server:${{ github.sha }} -t bb-license-server:latest -f Dockerfile .

      - name: Save Docker image to tar
        run: |
          docker save bb-license-server:latest -o image.tar
          gzip image.tar

      - name: Prepare files for deployment
        run: |
          # Create temporary directory with only necessary files
          mkdir -p deploy-temp
          
          # Copy necessary files and directories
          cp -r src deploy-temp/ || true
          cp -r migrations deploy-temp/ || true
          cp -r docker-nginx deploy-temp/ || true
          cp package.json deploy-temp/ || true
          cp package-lock.json deploy-temp/ || true
          cp tsconfig.json deploy-temp/ || true
          cp Dockerfile deploy-temp/ || true
          cp Dockerfile.dev deploy-temp/ || true
          cp docker-compose.prod.yml deploy-temp/ || true
          cp docker-compose.full.yml deploy-temp/ || true
          cp .env.production.example deploy-temp/ || true
          cp .dockerignore deploy-temp/ || true
          [ -f remote-deploy.sh ] && cp remote-deploy.sh deploy-temp/ || true
          [ -f start.sh ] && cp start.sh deploy-temp/ || true
          
          # Set proper permissions
          chmod -R 755 deploy-temp

      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VDS_HOST }}
          username: ${{ secrets.VDS_USER }}
          key: ${{ secrets.VDS_SSH_KEY }}
          port: ${{ secrets.VDS_SSH_PORT || 22 }}
          source: "deploy-temp/*"
          target: "/opt/bb-license-server"
          overwrite: true

      - name: Upload Docker image to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VDS_HOST }}
          username: ${{ secrets.VDS_USER }}
          key: ${{ secrets.VDS_SSH_KEY }}
          port: ${{ secrets.VDS_SSH_PORT || 22 }}
          source: "image.tar.gz"
          target: "/opt/bb-license-server/"

      - name: Deploy on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VDS_HOST }}
          username: ${{ secrets.VDS_USER }}
          key: ${{ secrets.VDS_SSH_KEY }}
          port: ${{ secrets.VDS_SSH_PORT || 22 }}
          script: |
            set -e
            cd /opt/bb-license-server
            
            # Load Docker image
            echo "üì¶ Loading Docker image..."
            if [ -f image.tar.gz ]; then
              gunzip -c image.tar.gz | docker load
              rm -f image.tar.gz
            else
              echo "‚ö†Ô∏è  image.tar.gz not found, skipping image load"
            fi
            
            # Ensure .env file exists
            if [ ! -f .env ]; then
              echo "‚ö†Ô∏è  .env file not found, creating from example..."
              if [ -f .env.production.example ]; then
                cp .env.production.example .env
                echo "‚ùå Please configure .env file on server before deploying!"
                exit 1
              else
                echo "‚ùå .env.production.example not found!"
                exit 1
              fi
            fi
            
            # Make remote-deploy.sh executable if it exists
            if [ -f remote-deploy.sh ]; then
              chmod +x remote-deploy.sh
            fi
            
            # Detect docker compose command (docker compose or docker-compose)
            if docker compose version > /dev/null 2>&1; then
              DOCKER_COMPOSE_CMD="docker compose"
            elif docker-compose --version > /dev/null 2>&1; then
              DOCKER_COMPOSE_CMD="docker-compose"
            else
              echo "‚ùå Neither 'docker compose' nor 'docker-compose' found!"
              exit 1
            fi
            
            echo "üì¶ Using: $DOCKER_COMPOSE_CMD"
            
            # Stop existing containers
            echo "üõë Stopping existing containers..."
            $DOCKER_COMPOSE_CMD -f docker-compose.prod.yml down || true
            
            # Build/rebuild nginx if needed (only on first deploy or config changes)
            echo "üî® Building nginx container..."
            $DOCKER_COMPOSE_CMD -f docker-compose.prod.yml build nginx || true
            
            # Pull latest postgres image
            echo "üîÑ Pulling base images..."
            $DOCKER_COMPOSE_CMD -f docker-compose.prod.yml pull postgres || true
            
            # Start services with new image
            echo "üöÄ Starting services..."
            $DOCKER_COMPOSE_CMD -f docker-compose.prod.yml up -d
            
            # Cleanup old images
            echo "üßπ Cleaning up old images..."
            docker image prune -f || true
            
            # Wait for health check
            echo "‚è≥ Waiting for services to be healthy..."
            sleep 15
            
            # Check health
            echo "üè• Checking service health..."
            MAX_RETRIES=5
            RETRY=0
            while [ $RETRY -lt $MAX_RETRIES ]; do
              if curl -f http://localhost/health > /dev/null 2>&1; then
                echo "‚úÖ Services are healthy!"
                break
              fi
              RETRY=$((RETRY + 1))
              if [ $RETRY -lt $MAX_RETRIES ]; then
                echo "‚è≥ Retry $RETRY/$MAX_RETRIES..."
                sleep 5
              else
                echo "‚ö†Ô∏è  Health check failed after $MAX_RETRIES attempts."
                echo "Check logs with: $DOCKER_COMPOSE_CMD -f docker-compose.prod.yml logs"
              fi
            done
            
            # Show status
            echo "üìä Service status:"
            $DOCKER_COMPOSE_CMD -f docker-compose.prod.yml ps

      - name: Cleanup
        if: always()
        run: |
          rm -f image.tar.gz
          rm -rf deploy-temp

